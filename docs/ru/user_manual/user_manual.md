# Руководство пользователя CulicidaeLab

Добро пожаловать в Руководство пользователя `CulicidaeLab`! Это руководство проведет вас через основные функции библиотеки, показывая, как выполнять обнаружение, классификацию и сегментацию комаров. Мы рассмотрим все, от начальной настройки до выполнения предсказаний и визуализации результатов.

## 1. Прежде чем начать: основные концепции

### Объект `settings`

Единственная наиболее важная концепция в `CulicidaeLab` — это **объект `settings`**. Это ваша централизованная точка входа ко всему. Вместо того чтобы импортировать и инициализировать каждый компонент вручную со сложными параметрами, вы просто:

1.  Получаете объект `settings`.
2.  Просите его создать нужный вам компонент (`Detector`, `Classifier` и т. д.).

Объект `settings` автоматически обрабатывает загрузку конфигураций, управление путями к файлам и загрузку моделей.

### Рабочий процесс предиктора

Все три основных компонента (`MosquitoDetector`, `MosquitoClassifier`, `MosquitoSegmenter`) являются **предикторами**. Они имеют общий, последовательный и предсказуемый рабочий процесс:

1.  **Инициализация**: Создать экземпляр из объекта `settings`.
2.  **Загрузка модели**: Веса модели загружаются лениво, то есть они загружаются и помещаются в память только при первом предсказании или когда вы явно укажете это сделать. Для ясности мы будем использовать `load_model=True`.
3.  **Предсказание**: Использовать метод `.predict()` на изображении.
4.  **Визуализация**: Использовать метод `.visualize()` для просмотра результатов.

Давайте начнем!

## 2. Инициализация и настройка

Сначала давайте настроим нашу среду и получим всемогущий объект `settings`.

```python
# Импорт необходимых библиотек для обработки изображений и построения графиков
import cv2
import matplotlib.pyplot as plt
from pathlib import Path

# Импорт основных компонентов CulicidaeLab
from culicidaelab import get_settings, MosquitoDetector, MosquitoClassifier, MosquitoSegmenter

# Получение центрального объекта настроек.
# Этот единственный объект будет использоваться для инициализации всех остальных компонентов.
settings = get_settings()

print("Настройки CulicidaeLab успешно инициализированы.")
```

## 3. Обнаружение комаров

Первым шагом во многих конвейерах анализа является выяснение, *есть ли* комар на изображении и *где* он находится. Это работа `MosquitoDetector`.

### 3.1. Инициализация детектора и загрузка изображения

Когда мы инициализируем детектор с `load_model=True`, библиотека проверяет, присутствуют ли веса модели YOLO локально. Если нет, они будут автоматически загружены и кэшированы для всех будущих использований.

```python
# Инициализация детектора.
# С load_model=True веса модели будут загружены в память.
print("Инициализация MosquitoDetector...")
detector = MosquitoDetector(settings=settings, load_model=True)
print("Модель детектора загружена и готова.")

# Давайте загрузим тестовое изображение для работы.
# Убедитесь, что вы заменили этот путь на путь к вашему собственному изображению.
image_path = Path("test_imgs") / "640px-Aedes_aegypti.jpg"
image = cv2.imread(str(image_path))

# Библиотека ожидает изображения в формате RGB, но OpenCV загружает их как BGR.
# Мы должны преобразовать цветовое пространство.
image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
```

### 3.2. Выполнение обнаружения

Метод `predict` принимает изображение в качестве входных данных и возвращает список всех обнаруженных объектов. Каждый объект представляет собой кортеж, содержащий координаты ограничивающей рамки и оценку уверенности. Формат: `(center_x, center_y, width, height, confidence)`.

```python
# Запуск предсказания на нашем RGB-изображении
detections = detector.predict(image_rgb)

# Давайте выведем результаты в удобочитаемом формате.
print("\nРезультаты обнаружения:")
if detections:
    for i, (x, y, w, h, conf) in enumerate(detections):
        print(
            f"  - Комар {i+1}: Уверенность = {conf:.2f}, Рамка = (x={x:.1f}, y={y:.1f}, w={w:.1f}, h={h:.1f})"
        )
else:
    print("  На изображении комары не обнаружены.")
```

### 3.3. Визуализация результатов обнаружения

Чтение координат полезно, но видеть результат лучше. Метод `.visualize()` рисует ограничивающие рамки и оценки уверенности непосредственно на изображении.

```python
# Передача исходного изображения и результатов обнаружения в метод visualize
annotated_image = detector.visualize(image_rgb, detections)

# Использование matplotlib для отображения итогового изображения
plt.figure(figsize=(10, 7))
plt.imshow(annotated_image)
plt.axis("off")
plt.title("Обнаруженные комары")
plt.show()
```

## 4. Классификация видов комаров

Как только у вас есть изображение комара, следующий вопрос часто звучит так: "Какой это вид?" `MosquitoClassifier` обучен отвечать на этот вопрос.

### 4.1. Инициализация классификатора

Как и в случае с детектором, мы инициализируем классификатор из объекта `settings`. Соответствующая модель классификации будет загружена при первом использовании.

```python
# Инициализация классификатора
print("\nИнициализация MosquitoClassifier...")
classifier = MosquitoClassifier(settings=settings, load_model=True)
print("Модель классификатора загружена и готова.")

# Для этого примера мы будем использовать то же изображение, что и для обнаружения.
# В реальном приложении вы могли бы использовать обрезанное изображение с выхода детектора.
```

### 4.2. Выполнение классификации

Метод `predict` классификатора возвращает список всех возможных видов, отсортированный по оценке уверенности. Каждый элемент — это кортеж `(название_вида, оценка_уверенности)`.

```python
# Запуск классификации
predictions = classifier.predict(image_rgb)

# Вывод трех наиболее вероятных видов
print("\nТоп-3 предсказания:")
for species, confidence in predictions[:3]:
    print(f"- {species}: {confidence:.4f}")
```

### 4.3. Интерпретация и визуализация результатов классификации

Гистограмма — отличный способ понять уверенность модели по всем потенциальным видам. Давайте визуализируем топ-5 предсказаний.

```python
# Извлечение названий и вероятностей топ-5 предсказаний для нашего графика
species_names = [p[0] for p in predictions[:5]]
probabilities = [p[1] for p in predictions[:5]]

# Создание горизонтальной гистограммы
plt.figure(figsize=(10, 6))
plt.barh(species_names, probabilities, color="skyblue")
plt.xlabel("Вероятность")
plt.title("Вероятности классификации видов (Топ-5)")
plt.gca().invert_yaxis()  # Инвертирование оси для отображения наиболее вероятного результата сверху

# Добавление значений вероятностей в виде текста на столбцах для наглядности
for index, value in enumerate(probabilities):
    plt.text(value, index, f" {value:.2%}", va='center')

plt.tight_layout()
plt.show()
```

## 5. Сегментация комаров

Сегментация идет на шаг дальше, чем обнаружение. Вместо простой рамки она предоставляет точную, попиксельную маску, очерчивающую точную форму комара.

### 5.1. Инициализация сегментатора

Снова мы инициализируем наш `MosquitoSegmenter` из объекта `settings`.

```python
# Инициализация сегментатора
print("\nИнициализация MosquitoSegmenter...")
segmenter = MosquitoSegmenter(settings=settings, load_model=True)
print("Модель сегментатора загружена и готова.")
```

### 5.2. Выполнение сегментации

Метод `predict` возвращает бинарную маску (2D numpy массив). В этой маске пиксели, принадлежащие комару, помечены как `True` (или `255`), а пиксели фона — как `False` (или `0`).

Существует два способа выполнения сегментации:

#### **Метод 1: Базовая сегментация**

Вы можете запустить сегментатор на всем изображении. Он попытается найти и сегментировать самый заметный объект.

```python
print("\n--- Выполнение базовой сегментации на всем изображении ---")
basic_mask = segmenter.predict(image_rgb)
print("Базовая сегментация завершена.")
```

#### **Метод 2: Сегментация с использованием результатов обнаружения (рекомендуется)**

Для наилучших результатов вы можете передать ограничивающие рамки, полученные от `MosquitoDetector`. Это говорит сегментатору, где именно искать, что приводит к более точной и чистой маске.

```python
# Мы будем использовать список 'detections', который мы получили от детектора ранее
print("\n--- Выполнение сегментации с использованием рамок обнаружения в качестве ориентира ---")
guided_mask = segmenter.predict(image_rgb, detection_boxes=detections)
print("Сегментация с ориентиром завершена.")
```

### 5.3. Визуализация результатов сегментации

Метод `.visualize()` идеально подходит для просмотра итоговой маски, наложенной на исходное изображение.

```python
# Визуализация более точной, управляемой маски
segmented_image = segmenter.visualize(image_rgb, guided_mask)

# Отображение исходного изображения, самой маски и итогового наложения
plt.figure(figsize=(18, 6))

plt.subplot(1, 3, 1)
plt.imshow(image_rgb)
plt.axis("off")
plt.title("Исходное изображение")

plt.subplot(1, 3, 2)
plt.imshow(guided_mask, cmap="gray")
plt.axis("off")
plt.title("Маска сегментации (с ориентиром)")

plt.subplot(1, 3, 3)
plt.imshow(segmented_image)
plt.axis("off")
plt.title("Наложение сегментации")

plt.tight_layout()
plt.show()
```

## 6. Следующие шаги: пакетная обработка и оценка

Для продвинутых пользователей, которым необходимо обрабатывать большие наборы данных или оценивать производительность модели, каждый предиктор также поддерживает:

-   **`.predict_batch()`**: Обрабатывает список изображений за один раз для значительно лучшей производительности.
-   **`.evaluate()` и `.evaluate_batch()`**: Сравнивает предсказания модели с набором данных с известными эталонными метками для вычисления метрик точности, таких как средняя точность (для обнаружения) и IoU (для сегментации).

Эти методы более сложны и требуют подготовки данных в определенном формате. Для получения подробной информации, пожалуйста, обратитесь к разделу **API Reference** нашей документации и изучите примеры кода, представленные в репозитории.
